<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developer Portal | Get API Key</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts (Poppins) -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Font Awesome untuk Ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main-card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            background: #fff;
        }

        .card-header-custom {
            background: #4e73df;
            padding: 30px;
            text-align: center;
            color: white;
        }

        .form-control {
            border-radius: 10px;
            padding: 12px;
            border: 1px solid #e1e5ea;
            background-color: #f8f9fc;
        }

        .form-control:focus {
            box-shadow: 0 0 0 3px rgba(78, 115, 223, 0.1);
            border-color: #4e73df;
            background-color: #fff;
        }

        .apikey-input {
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            letter-spacing: 1px;
            color: #2c3e50;
            background-color: #e8ecf4 !important;
            text-align: center;
        }

        .btn-custom {
            border-radius: 10px;
            padding: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-generate {
            background-color: #f6c23e;
            color: #fff;
            border: none;
        }
        .btn-generate:hover { background-color: #dda20a; color: #fff; }

        .btn-save {
            background-color: #1cc88a;
            color: #fff;
            border: none;
        }
        .btn-save:hover { background-color: #17a673; color: #fff; }

        .top-link {
            position: absolute;
            top: 20px;
            right: 20px;
            text-decoration: none;
            color: #4e73df;
            font-weight: 600;
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .top-link:hover { background: #f8f9fc; color: #224abe; }
    </style>
</head>
<body>

    <a href="login.html" class="top-link"><i class="fas fa-user-shield me-2"></i>Login Admin</a>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-6 col-md-8">
                
                <div class="card main-card">
                    <div class="card-header-custom">
                        <h3 class="m-0 fw-bold"><i class="fas fa-key me-2"></i>API Key Registration</h3>
                        <p class="m-0 mt-2 opacity-75">Dapatkan akses API Anda dalam hitungan detik</p>
                    </div>

                    <div class="card-body p-4 p-md-5">
                        
                        <!-- Form User -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small text-muted">Nama Depan <span class="text-danger">*</span></label>
                                <input type="text" id="fname" class="form-control" placeholder="firstName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small text-muted">Nama Belakang <span class="text-danger">*</span></label>
                                <input type="text" id="lname" class="form-control" placeholder="lastName" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label small text-muted">Alamat Email <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="fas fa-envelope text-muted"></i></span>
                                    <input type="email" id="email" class="form-control border-start-0 ps-0" placeholder="name@example.com" required>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4" style="opacity: 0.1;">

                        <!-- API Key Section -->
                        <div class="text-center mb-3">
                            <label class="form-label fw-bold text-primary">Generated API Key</label>
                            <div class="input-group mb-3">
                                <input type="text" id="apiKeyResult" class="form-control apikey-input" readonly placeholder="Isi data diatas & klik generate...">
                                <button onclick="generateKey()" class="btn btn-generate btn-custom" type="button">
                                    <i class="fas fa-sync-alt me-1"></i> Generate
                                </button>
                            </div>
                            <small class="text-muted d-block mb-3">*Key ini berlaku selama 30 hari.</small>
                        </div>

                        <!-- Save Button -->
                        <button onclick="saveData()" class="btn btn-save btn-custom w-100 py-3 shadow-sm">
                            <i class="fas fa-save me-2"></i> Simpan & Daftarkan Saya
                        </button>

                        <!-- Alert Box -->
                        <div id="alertBox" class="mt-4"></div>
                    </div>
                </div>

                <div class="text-center mt-4 text-muted small">
                    &copy; 2025 Irza API System. All rights reserved.
                </div>

            </div>
        </div>
    </div>

    <!-- SCRIPT VALIDASI BARU -->
    <script>
    async function generateKey() {
        console.log("Tombol Generate Ditekan..."); 
        
        // 1. AMBIL NILAI INPUT
        const fname = document.getElementById('fname').value.trim();
        const lname = document.getElementById('lname').value.trim();
        const email = document.getElementById('email').value.trim();
        const alertBox = document.getElementById('alertBox');
        
        // Reset Alert
        alertBox.innerHTML = '';

        // 2. CEK VALIDASI (PENTING!)
        if (!fname || !lname || !email) {
            // Jika ada yang kosong, tampilkan error dan BERHENTI (return)
            alertBox.innerHTML = `
                <div class="alert alert-warning border-0 shadow-sm animate__animated animate__shakeX">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Mohon Maaf!</strong> Harap isi Nama Depan, Belakang, dan Email terlebih dahulu sebelum generate key.
                </div>`;
            return; // Stop fungsi disini, jangan lanjut ke server
        }

        // 3. JIKA LOLOS VALIDASI, LANJUT KE SERVER
        const btn = document.querySelector('.btn-generate');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        
        try {
            const res = await fetch('http://localhost:3000/api/keys/generate');
            if (!res.ok) throw new Error(`Server Error: ${res.status}`);
            const data = await res.json();
            document.getElementById('apiKeyResult').value = data.key;
            
            // Beri notif kecil sukses generate
            alertBox.innerHTML = `<div class="alert alert-info border-0 py-2"><small><i class="fas fa-info-circle"></i> Key berhasil digenerate. Jangan lupa klik tombol <strong>Simpan</strong>.</small></div>`;

        } catch (error) {
            console.error("Gagal Generate:", error);
            alertBox.innerHTML = `<div class="alert alert-danger">Gagal koneksi ke server.</div>`;
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async function saveData() {
        console.log("Tombol Save Ditekan...");
        const fname = document.getElementById('fname').value.trim();
        const lname = document.getElementById('lname').value.trim();
        const email = document.getElementById('email').value.trim();
        const key = document.getElementById('apiKeyResult').value;
        const alertBox = document.getElementById('alertBox');

        alertBox.innerHTML = ''; 

        // Cek validasi lagi saat save (Double Protection)
        if(!key || !email || !fname || !lname) {
            alertBox.innerHTML = '<div class="alert alert-warning border-0 shadow-sm"><i class="fas fa-exclamation-triangle me-2"></i>Data belum lengkap atau Key belum digenerate!</div>';
            return;
        }

        const btnSave = document.querySelector('.btn-save');
        const originalText = btnSave.innerHTML;
        btnSave.innerHTML = 'Menyimpan...';
        btnSave.disabled = true;

        try {
            const res = await fetch('http://localhost:3000/api/users/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ firstName: fname, lastName: lname, email, generatedKey: key })
            });
            
            const result = await res.json();
            if(res.ok) {
                alertBox.innerHTML = `<div class="alert alert-success border-0 shadow-sm"><i class="fas fa-check-circle me-2"></i>Data Berhasil Disimpan!</div>`;
                // Reset form
                document.getElementById('fname').value = '';
                document.getElementById('lname').value = '';
                document.getElementById('email').value = '';
                document.getElementById('apiKeyResult').value = '';
            } else {
                alertBox.innerHTML = `<div class="alert alert-danger border-0 shadow-sm">Gagal: ${result.error}</div>`;
            }
        } catch (error) {
            alertBox.innerHTML = `<div class="alert alert-danger border-0 shadow-sm">Error koneksi server</div>`;
        } finally {
            btnSave.innerHTML = originalText;
            btnSave.disabled = false;
        }
    }
    </script>
</body>
</html>